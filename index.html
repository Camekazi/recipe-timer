<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Recipe Timer Generator</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      min-height: 100vh;
      padding: 20px;
      padding-bottom: 100px;
    }

    h1 { text-align: center; font-size: 1.8em; margin-bottom: 10px; color: #ff6b35; }
    .subtitle { text-align: center; color: #888; margin-bottom: 30px; font-size: 0.9em; }

    /* Setup Section */
    #setup-section { max-width: 500px; margin: 0 auto; }

    .input-group { margin-bottom: 20px; }
    .input-group label { display: block; margin-bottom: 8px; color: #ff6b35; font-weight: 600; }
    .input-group input, .input-group textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #333;
      border-radius: 12px;
      background: #252545;
      color: #eee;
      font-size: 1em;
    }
    .input-group textarea { min-height: 120px; resize: vertical; }
    .input-group input:focus, .input-group textarea:focus {
      outline: none;
      border-color: #ff6b35;
    }
    .input-group small { display: block; margin-top: 8px; color: #888; font-size: 0.85em; }
    .input-group small a { color: #ff6b35; }

    .warning-box {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 0.9em;
      color: #fbbf24;
    }

    #generate-btn {
      width: 100%;
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      color: white;
      border: none;
      padding: 18px;
      font-size: 1.2em;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
    }
    #generate-btn:hover { transform: scale(1.02); }
    #generate-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .cached-recipes { margin-top: 30px; }
    .cached-recipes h3 { color: #888; font-size: 0.9em; margin-bottom: 10px; }
    .cached-item {
      background: #252545;
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cached-item:hover { background: #2d2d5a; }
    .cached-item .title { font-weight: 600; }
    .cached-item .meta { color: #888; font-size: 0.85em; }

    /* Loading */
    #loading-section { display: none; text-align: center; padding: 60px 20px; }
    .spinner {
      width: 50px; height: 50px;
      border: 4px solid #333;
      border-top-color: #ff6b35;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Timer Section (reused from cod-fajitas) */
    #timer-section { display: none; }

    .elapsed-time {
      text-align: center;
      font-size: 2.5em;
      font-weight: bold;
      color: #ff6b35;
      margin-bottom: 20px;
      font-variant-numeric: tabular-nums;
    }

    .section-title {
      font-size: 0.85em;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #ff6b35;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 1px solid #333;
    }

    .current-step {
      background: linear-gradient(135deg, #2d4a3e 0%, #1e3a2f 100%);
      border: 2px solid #4ade80;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 0 20px rgba(74, 222, 128, 0.2);
    }
    .current-step h2 { font-size: 1.4em; margin-bottom: 10px; color: #4ade80; }
    .current-step p { color: #ccc; line-height: 1.6; }
    .current-step .duration { margin-top: 15px; font-size: 1.1em; color: #4ade80; }

    .upcoming-step {
      background: #252545;
      border-radius: 12px;
      padding: 15px 20px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 4px solid #ff6b35;
    }
    .upcoming-step.soon { border-left-color: #fbbf24; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .upcoming-step .title { font-weight: 600; margin-bottom: 3px; }
    .upcoming-step .detail { font-size: 0.85em; color: #888; }
    .upcoming-step .countdown {
      font-size: 1.2em;
      font-weight: bold;
      color: #ff6b35;
      font-variant-numeric: tabular-nums;
      min-width: 60px;
      text-align: right;
    }

    .timeline-step {
      display: flex;
      padding: 12px 0;
      border-bottom: 1px solid #333;
    }
    .timeline-step.completed { opacity: 0.5; }
    .timeline-step.completed .timeline-title { text-decoration: line-through; }
    .timeline-step.active {
      background: rgba(74, 222, 128, 0.1);
      margin: 0 -20px;
      padding: 12px 20px;
      border-radius: 8px;
    }
    .timeline-time { min-width: 70px; font-size: 0.85em; color: #888; }
    .timeline-content { flex: 1; }
    .timeline-title { font-weight: 600; margin-bottom: 3px; }
    .timeline-detail { font-size: 0.85em; color: #888; }

    .done-section { display: none; text-align: center; padding: 60px 20px; }
    .done-section h2 { font-size: 2em; margin-bottom: 20px; }

    .paused-banner {
      display: none;
      background: #fbbf24;
      color: #000;
      text-align: center;
      padding: 10px;
      font-weight: bold;
      margin-bottom: 20px;
      border-radius: 8px;
    }

    .controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1a1a2e;
      padding: 15px 20px;
      display: none;
      gap: 10px;
      border-top: 1px solid #333;
    }
    .controls button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
    }
    #pause-btn { background: #fbbf24; color: #000; }
    #reset-btn { background: #ef4444; color: white; }
    #new-btn { background: #6366f1; color: white; }

    .error-msg { color: #ef4444; text-align: center; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Recipe Timer</h1>
  <p class="subtitle">AI-powered cooking timers</p>

  <!-- Setup Section -->
  <div id="setup-section">
    <div class="input-group">
      <label>Gemini API Key</label>
      <input type="password" id="api-key" placeholder="Enter your Gemini API key">
      <small>
        Get a free key at <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a> (250 requests/day free)
      </small>
    </div>

    <div class="warning-box">
      Your API key is stored in your browser's localStorage. It's visible in DevTools. Only use keys with quota limits.
    </div>

    <div class="input-group">
      <label>What are you cooking?</label>
      <textarea id="recipe-input" placeholder="e.g., Chicken stir fry with vegetables&#10;&#10;Or paste a full recipe with ingredients and steps..."></textarea>
    </div>

    <button id="generate-btn" onclick="generateTimer()">Generate Timer</button>
    <div id="error-msg" class="error-msg"></div>

    <div id="cached-section" class="cached-recipes" style="display: none;">
      <h3>Recent Recipes</h3>
      <div id="cached-list"></div>
    </div>
  </div>

  <!-- Loading Section -->
  <div id="loading-section">
    <div class="spinner"></div>
    <p>Generating your cooking timer...</p>
  </div>

  <!-- Timer Section -->
  <div id="timer-section">
    <div class="paused-banner" id="paused-banner">PAUSED</div>
    <div class="elapsed-time" id="elapsed-time">00:00</div>

    <div class="section-title">Do This Now</div>
    <div class="current-step" id="current-step">
      <h2>Loading...</h2>
      <p></p>
    </div>

    <div class="upcoming-section">
      <div class="section-title">Coming Up Next</div>
      <div id="upcoming-steps"></div>
    </div>

    <div class="timeline-section" style="margin-top: 40px;">
      <div class="section-title">Full Timeline</div>
      <div id="timeline"></div>
    </div>
  </div>

  <!-- Done Section -->
  <div class="done-section" id="done-section">
    <h2>All Done!</h2>
    <p id="done-message">Your meal is ready to serve!</p>
  </div>

  <!-- Controls -->
  <div class="controls" id="controls">
    <button id="pause-btn" onclick="togglePause()">Pause</button>
    <button id="reset-btn" onclick="resetTimer()">Reset</button>
    <button id="new-btn" onclick="newRecipe()">New Recipe</button>
  </div>

  <script>
    // Safe localStorage wrapper (iOS Safari blocks on file:// URLs)
    const storage = {
      get: (key) => { try { return localStorage.getItem(key); } catch(e) { return null; } },
      set: (key, val) => { try { localStorage.setItem(key, val); } catch(e) {} },
      remove: (key) => { try { localStorage.removeItem(key); } catch(e) {} }
    };

    let steps = [];
    let recipeTitle = '';
    let startTime = null;
    let pausedTime = null;
    let isPaused = false;
    let intervalId = null;

    // Load saved API key
    window.onload = function() {
      const savedKey = storage.get('geminiApiKey');
      if (savedKey) document.getElementById('api-key').value = savedKey;

      loadCachedRecipes();

      // Check for active timer session
      const activeRecipe = storage.get('activeRecipe');
      if (activeRecipe) {
        const data = JSON.parse(activeRecipe);
        if (confirm(`Resume "${data.title}"?`)) {
          steps = data.steps;
          recipeTitle = data.title;
          startCooking();
        } else {
          storage.remove('activeRecipe');
          storage.remove('timerStartTime');
        }
      }
    };

    function loadCachedRecipes() {
      const cached = storage.get('cachedRecipes');
      if (!cached) return;

      const recipes = JSON.parse(cached);
      if (recipes.length === 0) return;

      const list = document.getElementById('cached-list');
      list.innerHTML = recipes.slice(0, 5).map((r, i) => `
        <div class="cached-item" onclick="loadCached(${i})">
          <div>
            <div class="title">${r.title}</div>
            <div class="meta">${r.steps.length} steps</div>
          </div>
          <span>â†’</span>
        </div>
      `).join('');

      document.getElementById('cached-section').style.display = 'block';
    }

    function loadCached(index) {
      const cached = JSON.parse(storage.get('cachedRecipes'));
      const recipe = cached[index];
      steps = recipe.steps;
      recipeTitle = recipe.title;
      saveActiveRecipe();
      startCooking();
    }

    async function generateTimer() {
      const apiKey = document.getElementById('api-key').value.trim();
      const recipeInput = document.getElementById('recipe-input').value.trim();
      const errorEl = document.getElementById('error-msg');

      if (!apiKey) { errorEl.textContent = 'Please enter your API key'; return; }
      if (!recipeInput) { errorEl.textContent = 'Please describe what you\'re cooking'; return; }

      errorEl.textContent = '';
      storage.set('geminiApiKey', apiKey);

      // Show loading
      document.getElementById('setup-section').style.display = 'none';
      document.getElementById('loading-section').style.display = 'block';

      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [{
                  text: `Create a cooking timer for this recipe. Return ONLY valid JSON, no markdown.

Recipe: ${recipeInput}

Return this exact JSON structure:
{
  "title": "Recipe Name",
  "totalMinutes": 30,
  "steps": [
    {"time": 0, "title": "Step name", "detail": "What to do", "duration": 300},
    {"time": 300, "title": "Next step", "detail": "Instructions", "duration": 180}
  ]
}

Rules:
- time = seconds from start when step begins
- duration = how long this step takes in seconds
- Each step's time should equal previous step's time + duration
- Include prep, cooking, and any resting time
- Be realistic about timing
- Keep details concise but helpful`
                }]
              }],
              generationConfig: {
                temperature: 0.7,
                maxOutputTokens: 2048
              }
            })
          }
        );

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error?.message || 'API request failed');
        }

        const data = await response.json();
        const text = data.candidates[0].content.parts[0].text;

        // Parse JSON (handle markdown code blocks)
        let jsonStr = text;
        if (text.includes('```')) {
          jsonStr = text.replace(/```json?\n?/g, '').replace(/```/g, '').trim();
        }

        const recipe = JSON.parse(jsonStr);
        steps = recipe.steps;
        recipeTitle = recipe.title;

        // Cache the recipe
        cacheRecipe(recipe);
        saveActiveRecipe();

        startCooking();

      } catch (err) {
        console.error(err);
        document.getElementById('loading-section').style.display = 'none';
        document.getElementById('setup-section').style.display = 'block';
        errorEl.textContent = `Error: ${err.message}`;
      }
    }

    function cacheRecipe(recipe) {
      let cached = JSON.parse(storage.get('cachedRecipes') || '[]');
      // Remove duplicate titles
      cached = cached.filter(r => r.title !== recipe.title);
      cached.unshift(recipe);
      cached = cached.slice(0, 10); // Keep last 10
      storage.set('cachedRecipes', JSON.stringify(cached));
    }

    function saveActiveRecipe() {
      storage.set('activeRecipe', JSON.stringify({ title: recipeTitle, steps }));
    }

    function startCooking() {
      const saved = storage.get('timerStartTime');
      const savedPaused = storage.get('timerPausedTime');

      if (saved && !savedPaused) {
        startTime = parseInt(saved);
      } else if (saved && savedPaused) {
        const pauseDuration = Date.now() - parseInt(savedPaused);
        startTime = parseInt(saved) + pauseDuration;
        storage.set('timerStartTime', startTime);
        storage.remove('timerPausedTime');
      } else {
        startTime = Date.now();
        storage.set('timerStartTime', startTime);
      }

      document.getElementById('loading-section').style.display = 'none';
      document.getElementById('setup-section').style.display = 'none';
      document.getElementById('timer-section').style.display = 'block';
      document.getElementById('controls').style.display = 'flex';

      document.querySelector('h1').textContent = recipeTitle;

      renderTimeline();
      updateDisplay();
      intervalId = setInterval(updateDisplay, 1000);
    }

    function togglePause() {
      isPaused = !isPaused;
      const btn = document.getElementById('pause-btn');
      const banner = document.getElementById('paused-banner');

      if (isPaused) {
        pausedTime = Date.now();
        storage.set('timerPausedTime', pausedTime);
        btn.textContent = 'Resume';
        banner.style.display = 'block';
        clearInterval(intervalId);
      } else {
        const pauseDuration = Date.now() - pausedTime;
        startTime += pauseDuration;
        storage.set('timerStartTime', startTime);
        storage.remove('timerPausedTime');
        pausedTime = null;
        btn.textContent = 'Pause';
        banner.style.display = 'none';
        intervalId = setInterval(updateDisplay, 1000);
      }
    }

    function resetTimer() {
      if (confirm('Reset the timer? This will start over.')) {
        storage.remove('timerStartTime');
        storage.remove('timerPausedTime');
        clearInterval(intervalId);
        startTime = Date.now();
        storage.set('timerStartTime', startTime);
        isPaused = false;
        document.getElementById('pause-btn').textContent = 'Pause';
        document.getElementById('paused-banner').style.display = 'none';
        document.getElementById('done-section').style.display = 'none';
        document.getElementById('timer-section').style.display = 'block';
        renderTimeline();
        updateDisplay();
        intervalId = setInterval(updateDisplay, 1000);
      }
    }

    function newRecipe() {
      storage.remove('timerStartTime');
      storage.remove('timerPausedTime');
      storage.remove('activeRecipe');
      clearInterval(intervalId);
      location.reload();
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function formatClockTime(seconds) {
      const d = new Date(startTime + seconds * 1000);
      return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
    }

    function getElapsedSeconds() {
      return Math.floor((Date.now() - startTime) / 1000);
    }

    function getCurrentStepIndex(elapsed) {
      for (let i = steps.length - 1; i >= 0; i--) {
        if (elapsed >= steps[i].time) return i;
      }
      return 0;
    }

    function updateDisplay() {
      const elapsed = getElapsedSeconds();
      const totalTime = steps[steps.length - 1].time + steps[steps.length - 1].duration;

      document.getElementById('elapsed-time').textContent = formatTime(elapsed);

      if (elapsed >= totalTime) {
        document.getElementById('timer-section').style.display = 'none';
        document.getElementById('done-section').style.display = 'block';
        document.getElementById('done-message').textContent = `${recipeTitle} is ready!`;
        storage.remove('activeRecipe');
        storage.remove('timerStartTime');
        clearInterval(intervalId);
        return;
      }

      const currentIndex = getCurrentStepIndex(elapsed);
      const current = steps[currentIndex];
      const timeInStep = elapsed - current.time;
      const remaining = current.duration - timeInStep;

      document.getElementById('current-step').innerHTML = `
        <h2>${current.title}</h2>
        <p>${current.detail}</p>
        ${remaining > 0 ? `<div class="duration">${formatTime(Math.max(0, remaining))} remaining</div>` : ''}
      `;

      // Upcoming
      const upcomingEl = document.getElementById('upcoming-steps');
      const upcoming = steps.slice(currentIndex + 1, currentIndex + 4);
      upcomingEl.innerHTML = upcoming.map(step => {
        const countdown = step.time - elapsed;
        return `
          <div class="upcoming-step ${countdown < 120 ? 'soon' : ''}">
            <div>
              <div class="title">${step.title}</div>
              <div class="detail">${step.detail.substring(0, 50)}${step.detail.length > 50 ? '...' : ''}</div>
            </div>
            <div class="countdown">${formatTime(countdown)}</div>
          </div>
        `;
      }).join('');

      // Timeline
      document.querySelectorAll('.timeline-step').forEach((el, i) => {
        el.classList.remove('completed', 'active');
        if (i < currentIndex) el.classList.add('completed');
        if (i === currentIndex) el.classList.add('active');
      });
    }

    function renderTimeline() {
      document.getElementById('timeline').innerHTML = steps.map((step, i) => `
        <div class="timeline-step" data-index="${i}">
          <div class="timeline-time">${formatClockTime(step.time)}</div>
          <div class="timeline-content">
            <div class="timeline-title">${step.title}</div>
            <div class="timeline-detail">${step.detail}</div>
          </div>
        </div>
      `).join('');
    }
  </script>
</body>
</html>
